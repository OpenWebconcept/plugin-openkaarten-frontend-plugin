(()=>{"use strict";const e=window.wp.blocks,t=window.React,n=window.wp.blockEditor,a=window.wp.components,r=window.wp.element,s=window.wp.i18n,o=JSON.parse('{"$schema":"https://schemas.wp.org/trunk/block.json","title":"OWC Openmaps Openstreet Map","description":"OWC Openmaps Openstreet Map","icon":"admin-site-alt","name":"owc-openkaarten/streetmap","category":"openkaarten-frontend-plugin","textdomain":"openkaarten-frontend-plugin","attributes":{"rest_uri":{"type":"string","default":""},"selected_datasets":{"type":"array","default":[]},"tile_layer_uri":{"type":"string","default":"https://{s}.tile.osm.org/{z}/{x}/{y}.png"}},"style":["owc-openkaarten-streetmap-block"],"supports":{"align":false,"className":false,"customClassName":false,"html":false,"multiple":false},"keywords":["owc","openwebconcept","openmaps","map","locations"],"viewScript":["owc-openkaarten-streetmap-block"],"version":"0.1.0"}'),{name:l}=o;(0,e.registerBlockType)(l,{...o,edit:function({attributes:e,setAttributes:o}){const[l,i]=(0,r.useState)(null),[p,u]=(0,r.useState)(!1),[d,c]=(0,r.useState)(null),[m,_]=(0,r.useState)(e.selected_datasets),f=(0,r.useMemo)((()=>{try{const t=new URL(e.rest_uri);return"http:"===t.protocol||"https:"===t.protocol||i((0,s.__)("Invalid URL","openkaarten-frontend-plugin"))}catch(e){return i((0,s.__)("Invalid URL","openkaarten-frontend-plugin")),!1}}),[e.rest_uri]);(0,r.useEffect)((()=>{if(f){i(null);const{username:t,password:n,url:a}=function(e){try{const t=new URL(e),n=t.username||"",a=t.password||"";return t.username="",t.password="",{username:n,password:a,url:t.toString()}}catch(t){return console.error("Invalid URL provided:",t),{username:"",password:"",url:e}}}(e.rest_uri);fetch("/wp-json/openkaarten-frontend-plugin/v1/proxy-datasets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:`${a}wp-json/owc/openkaarten/v1/datasets?_locale=default`,username:t,password:n})}).then((e=>e.ok?e.json():e.json().then((t=>{throw console.error("Server error response:",t),i((0,s.__)(`Fetching datasets failed: ${t.debug_info||"Unknown error"}`,"openkaarten-frontend-plugin")),new Error(t.message||`HTTP ${e.status}`)})).catch((()=>{throw new Error(`Error status: ${e.status}`)})))).then((e=>{if("string"==typeof e)try{e=JSON.parse(e)}catch(e){return i((0,s.__)("Error parsing nested JSON","openkaarten-frontend-plugin")),console.error("Error parsing nested JSON:",e),void c([])}e&&"DatasetCollection"===e.type&&Array.isArray(e.datasets)?(i(null),c(e.datasets)):(i((0,s.__)("Unexpected response format or 'datasets' is not an array.","openkaarten-frontend-plugin")),console.error("Unexpected response format or 'datasets' is not an array."),c([]))})).catch((e=>{i((0,s.__)("Fetching datasets failed","openkaarten-frontend-plugin")),console.error("Fetching datasets failed:",e.message),c([])}))}}),[e.rest_uri,f]);const g=(0,r.useMemo)((()=>{if(!d)return[];const e=d.map((e=>({value:e.id.toString(),label:e.title?e.title:"Untitled"})));return e.unshift({value:"",label:d?.length>0?(0,s.__)("Select the datalayers you want to display on the map","openkaarten-frontend-plugin"):(0,s.__)("No datalayers found","openkaarten-frontend-plugin"),disabled:!0}),e}),[d]);return(0,r.useLayoutEffect)((()=>{const e=g.filter((e=>m.includes(e.value))).map((e=>e.label)),t=document.getElementById("datalayers");t&&(t.innerHTML=e.length>0?e.join("<br>"):(0,s.__)("No datalayers selected","openkaarten-frontend-plugin"))}),[m,g]),(0,t.createElement)(t.Fragment,null,(0,t.createElement)(n.BlockControls,null),(0,t.createElement)("div",{className:"owc-openkaarten-streetmap"},(0,t.createElement)(a.__experimentalInputControl,{label:(0,s.__)("URL to rest-endpoint or Domain URL","openkaarten-frontend-plugin"),value:e.rest_uri,onChange:e=>{u(!0),o({rest_uri:e})},onBlur:()=>{u(!1)}}),!!e.rest_uri&&!p&&l&&(0,t.createElement)(a.Notice,{status:"error",isDismissible:!1},(0,t.createElement)("p",null,l)),(0,t.createElement)("div",{className:"owc-openkaarten-streetmap__row"},(0,t.createElement)(a.SelectControl,{multiple:!0,label:(0,s.__)("Select datalayers:","openkaarten-frontend-plugin"),value:e.selected_datasets,onClick:e=>{const t=e.target.value?m.includes(e.target.value)?m.filter((t=>t!==e.target.value)):[...m,e.target.value]:[];_(t),o({selected_datasets:t})},options:g.length?g:[{value:"",label:(0,s.__)("No datalayers found","openkaarten-frontend-plugin"),disabled:!0}]}),(0,t.createElement)("div",{className:"components-message-box"},(0,t.createElement)("label",{className:"css-1imalal"},(0,s.__)("Selected datalayers","openkaarten-frontend-plugin")),(0,t.createElement)("p",{id:"datalayers"},(0,s.__)("No datalayers selected","openkaarten-frontend-plugin")))),(0,t.createElement)(a.__experimentalInputControl,{label:(0,s.__)("URL template for tile layer","openkaarten-frontend-plugin"),value:e.tile_layer_uri,onChange:e=>{o({tile_layer_uri:e})}})))},save:()=>null})})();