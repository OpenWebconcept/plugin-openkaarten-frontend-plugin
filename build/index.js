(()=>{"use strict";const e=window.wp.blocks,t=window.React,a=window.wp.blockEditor,n=window.wp.components,r=window.wp.element,s=window.wp.i18n,l=JSON.parse('{"$schema":"https://schemas.wp.org/trunk/block.json","title":"OWC Openmaps Openstreet Map","description":"OWC Openmaps Openstreet Map","icon":"admin-site-alt","name":"owc-openkaarten/streetmap","category":"openkaarten-frontend-plugin","textdomain":"openkaarten-frontend-plugin","attributes":{"rest_uri":{"type":"string","default":""},"selected_datasets":{"type":"array","default":[]},"tile_layer_uri":{"type":"string","default":"https://{s}.tile.osm.org/{z}/{x}/{y}.png"}},"style":["owc-openkaarten-streetmap-block"],"supports":{"align":false,"className":false,"customClassName":false,"html":false,"multiple":false},"keywords":["owc","openwebconcept","openmaps","map","locations"],"viewScript":["owc-openkaarten-streetmap-block"],"version":"0.1.0"}'),{name:o}=l;(0,e.registerBlockType)(o,{...l,edit:function({attributes:e,setAttributes:l}){const[o,i]=(0,r.useState)(!1),[p,u]=(0,r.useState)(null),[c,d]=(0,r.useState)(e.selected_datasets),m=(0,r.useMemo)((()=>{try{return new URL(e.rest_uri),!0}catch(e){return!1}}),[e.rest_uri]);(0,r.useEffect)((()=>{if(m){const{username:t,password:a,url:n}=function(e){try{const t=new URL(e),a=t.username||"",n=t.password||"";return t.username="",t.password="",{username:a,password:n,url:t.toString()}}catch(t){return console.error("Invalid URL provided:",t),{username:"",password:"",url:e}}}(e.rest_uri);fetch("/wp-json/openkaarten-frontend-plugin/v1/proxy-datasets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:`${n}wp-json/owc/openkaarten/v1/datasets?_locale=default`,username:t,password:a})}).then((e=>{if(!e.ok)throw new Error(`Error status: ${e.status}`);return e.json()})).then((e=>{if("string"==typeof e)try{e=JSON.parse(e)}catch(e){return console.error("Error parsing nested JSON:",e),void u([])}e&&"DatasetCollection"===e.type&&Array.isArray(e.datasets)?u(e.datasets):(console.error("Unexpected response format or 'datasets' is not an array."),u([]))})).catch((e=>{console.error("Fetching datasets failed:",e.message),u([])}))}}),[e.rest_uri,m]);const _=(0,r.useMemo)((()=>{if(!p)return[];const e=p.map((e=>({value:e.id.toString(),label:e.title?e.title:"Untitled"})));return e.unshift({value:"",label:(0,s.__)("Select the datalayers you want to display on the map","openkaarten-frontend-plugin"),disabled:!0}),e}),[p]);return(0,r.useLayoutEffect)((()=>{const e=_.filter((e=>c.includes(e.value))).map((e=>e.label)),t=document.getElementById("datalayers");t&&(t.innerHTML=e.length>0?e.join("<br>"):(0,s.__)("No datalayers selected","openkaarten-frontend-plugin"))}),[c,_]),(0,t.createElement)(t.Fragment,null,(0,t.createElement)(a.BlockControls,null),(0,t.createElement)("div",{className:"owc-openkaarten-streetmap"},(0,t.createElement)(n.__experimentalInputControl,{label:(0,s.__)("URL to rest-endpoint or Domain URL","openkaarten-frontend-plugin"),value:e.rest_uri,onChange:e=>{i(!0),l({rest_uri:e})},onBlur:()=>{i(!1)}}),!!e.rest_uri&&!o&&!m&&(0,t.createElement)(n.Notice,{status:"error"},(0,t.createElement)("p",null,(0,s.__)("Invalid URL","openkaarten-frontend-plugin"))),(0,t.createElement)("div",{className:"owc-openkaarten-streetmap__row"},(0,t.createElement)(n.SelectControl,{multiple:!0,label:(0,s.__)("Select datalayers:","openkaarten-frontend-plugin"),value:e.selected_datasets,onClick:e=>{const t=e.target.value?c.includes(e.target.value)?c.filter((t=>t!==e.target.value)):[...c,e.target.value]:[];d(t),l({selected_datasets:t})},options:_.length?_:[{value:"",label:(0,s.__)("No datalayers found","openkaarten-frontend-plugin"),disabled:!0}]}),(0,t.createElement)("div",{className:"components-message-box"},(0,t.createElement)("label",{className:"css-1imalal"},(0,s.__)("Selected datalayers","openkaarten-frontend-plugin")),(0,t.createElement)("p",{id:"datalayers"},(0,s.__)("No datalayers selected","openkaarten-frontend-plugin")))),(0,t.createElement)(n.__experimentalInputControl,{label:(0,s.__)("URL template for tile layer","openkaarten-frontend-plugin"),value:e.tile_layer_uri,onChange:e=>{l({tile_layer_uri:e})}})))},save:()=>null})})();